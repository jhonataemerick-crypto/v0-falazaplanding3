# Fluxo Completo de Subscriptions e Etapas do Funil

## VisÃ£o Geral

Este documento descreve o fluxo completo desde o cadastro do usuÃ¡rio atÃ© a ativaÃ§Ã£o da subscription e atualizaÃ§Ã£o da etapa do funil.

## Etapas do Funil

\`\`\`
Lead â†’ Trial â†’ User â†’ Churn
\`\`\`

- **Lead**: UsuÃ¡rio cadastrado mas nÃ£o assinou
- **Trial**: UsuÃ¡rio em perÃ­odo de teste (trial)
- **User**: UsuÃ¡rio pagante ativo
- **Churn**: UsuÃ¡rio que cancelou ou estÃ¡ com pagamento atrasado

## Fluxo Detalhado

### 1. Cadastro do UsuÃ¡rio

\`\`\`
UsuÃ¡rio preenche formulÃ¡rio â†’ Supabase Auth cria usuÃ¡rio â†’ Trigger cria profile
\`\`\`

**Tabelas afetadas:**
- `auth.users` (Supabase Auth)
- `public.profiles` (via trigger)

**Estado inicial:**
- `profiles.etapa_funil` = 'Lead'

**CÃ³digo:**
- `app/auth/signup/page.tsx`
- `scripts/001_create_profiles_table.sql` (trigger)

### 2. SeleÃ§Ã£o de Plano

\`\`\`
UsuÃ¡rio faz login â†’ Acessa /subscription â†’ Escolhe plano â†’ Clica em "Assinar"
\`\`\`

**CÃ³digo:**
- `app/subscription/page.tsx`
- `components/subscription-plans.tsx`

**Logs esperados:**
\`\`\`
[v0] Opening checkout for plan: starter User: xxx
[v0] Starting checkout session for product: starter
\`\`\`

### 3. CriaÃ§Ã£o do Checkout

\`\`\`
Cliente chama API â†’ API cria session no Stripe â†’ Redireciona para Stripe Checkout
\`\`\`

**CÃ³digo:**
- `app/api/checkout/route.ts`

**Dados enviados ao Stripe:**
\`\`\`typescript
{
  mode: 'subscription',
  customer_email: user.email,
  metadata: {
    userId: user.id,
    planName: 'Starter',
    planPrice: '97'
  },
  subscription_data: {
    trial_period_days: 7
  }
}
\`\`\`

**Logs esperados:**
\`\`\`
[v0] Creating checkout session for user: xxx product: starter
[v0] Checkout session created successfully: cs_test_xxx
\`\`\`

### 4. Pagamento no Stripe

\`\`\`
UsuÃ¡rio preenche dados â†’ Stripe processa â†’ Stripe cria subscription
\`\`\`

**O que acontece no Stripe:**
1. Valida cartÃ£o
2. Cria customer (se nÃ£o existir)
3. Cria subscription com status 'trialing' (se tem trial) ou 'active'
4. Dispara webhook `checkout.session.completed`

### 5. Webhook Recebe Evento

\`\`\`
Stripe envia POST â†’ /api/webhooks/stripe â†’ Verifica assinatura â†’ Processa evento
\`\`\`

**CÃ³digo:**
- `app/api/webhooks/stripe/route.ts`

**Logs esperados:**
\`\`\`
[v0] ========== STRIPE WEBHOOK RECEIVED ==========
[v0] âœ… Webhook signature verified successfully
[v0] Event Type: checkout.session.completed
[v0] ğŸ’³ CHECKOUT SESSION COMPLETED
[v0] Session ID: cs_test_xxx
[v0] Customer: cus_xxx
[v0] Subscription: sub_xxx
\`\`\`

### 6. CriaÃ§Ã£o da Subscription no Banco

\`\`\`
Webhook extrai dados â†’ Chama createSubscription() â†’ Insere na tabela subscriptions
\`\`\`

**CÃ³digo:**
- `lib/supabase/subscriptions.ts`

**Dados inseridos:**
\`\`\`typescript
{
  user_id: 'xxx',
  stripe_customer_id: 'cus_xxx',
  stripe_subscription_id: 'sub_xxx',
  plan_name: 'Starter',
  plan_price: 97,
  status: 'trialing', // ou 'active'
  trial_ends_at: '2025-01-15T00:00:00Z',
  current_period_start: '2025-01-08T00:00:00Z',
  current_period_end: '2025-02-08T00:00:00Z'
}
\`\`\`

**Logs esperados:**
\`\`\`
[v0] âœ… Retrieved subscription from Stripe: sub_xxx
[v0] Subscription status: trialing
[v0] Trial end: 2025-01-15T00:00:00.000Z
[v0] Creating subscription in database with data: {...}
[v0] âœ…âœ…âœ… SUBSCRIPTION CREATED SUCCESSFULLY âœ…âœ…âœ…
\`\`\`

### 7. Trigger Atualiza Etapa do Funil

\`\`\`
INSERT em subscriptions â†’ Trigger dispara â†’ Atualiza profiles.etapa_funil
\`\`\`

**CÃ³digo:**
- `scripts/007_fix_etapa_funil_trigger.sql`

**LÃ³gica do trigger:**
\`\`\`sql
IF NEW.status = 'trialing' THEN
  UPDATE profiles SET etapa_funil = 'Trial'
ELSIF NEW.status = 'active' THEN
  UPDATE profiles SET etapa_funil = 'User'
ELSIF NEW.status IN ('canceled', 'past_due', 'unpaid') THEN
  UPDATE profiles SET etapa_funil = 'Churn'
END IF
\`\`\`

**Logs esperados (Postgres):**
\`\`\`
NOTICE: Etapa funil atualizada para user_id xxx: Lead -> Trial (subscription status: trialing)
\`\`\`

### 8. UsuÃ¡rio Acessa Dashboard

\`\`\`
UsuÃ¡rio volta ao site â†’ Middleware verifica auth â†’ Busca subscription â†’ Permite acesso
\`\`\`

**CÃ³digo:**
- `middleware.ts`
- `app/dashboard/page.tsx`

**VerificaÃ§Ãµes:**
- UsuÃ¡rio estÃ¡ autenticado?
- Subscription existe e estÃ¡ ativa?
- Etapa do funil permite acesso?

## Diagrama de SequÃªncia

\`\`\`
UsuÃ¡rio          App              Stripe           Webhook          Database
   |              |                 |                 |                 |
   |--Cadastro-|                 |                 |                 |
   |              |--Create User-|                 |                 |
   |              |                 |                 |--Insert Profile->|
   |              |                 |                 |  (etapa=Lead)   |
   |              |                 |                 |                 |
   |--Assinar--|                 |                 |                 |
   |              |--Create Session>|                 |                 |
   |              |<--Session URL---|                 |                 |
   |              |                 |                 |                 |
   |--Pagar----|--------------|                 |                 |
   |              |                 |--Process-----|                 |
   |              |                 |                 |                 |
   |              |                 |--Webhook Event->|                 |
   |              |                 |                 |--Insert Sub--|
   |              |                 |                 |                 |
   |              |                 |                 |<--Trigger-------|
   |              |                 |                 |  (Update etapa) |
   |              |                 |                 |                 |
   |<-Redirect----|                 |                 |                 |
   |              |                 |                 |                 |
   |--Dashboard|                 |                 |                 |
   |              |--Check Sub---|                 |                 |
   |              |<--Sub Active----|                 |                 |
   |<--Content----|                 |                 |                 |
\`\`\`

## Estados PossÃ­veis

### Subscription Status (Stripe)

- `trialing`: Em perÃ­odo de teste
- `active`: Ativa e pagando
- `past_due`: Pagamento atrasado
- `canceled`: Cancelada
- `unpaid`: NÃ£o paga

### Etapa Funil (Nossa App)

- `Lead`: Cadastrado, sem subscription
- `Trial`: Subscription com status 'trialing'
- `User`: Subscription com status 'active'
- `Churn`: Subscription cancelada ou com problemas

## TransiÃ§Ãµes de Estado

\`\`\`
Lead --[cria subscription trialing] Trial
Lead --[cria subscription active]-- User
Trial --[trial termina e paga]----- User
Trial --[cancela durante trial]---- Churn
User --[cancela subscription]------ Churn
User --[pagamento falha]----------- Churn
Churn --[reativa subscription]----- User
\`\`\`

## VerificaÃ§Ãµes e DiagnÃ³sticos

### Verificar estado atual de um usuÃ¡rio

\`\`\`sql
SELECT 
  p.id,
  p.email,
  p.etapa_funil,
  s.status as subscription_status,
  s.stripe_subscription_id,
  s.trial_ends_at,
  s.current_period_end
FROM profiles p
LEFT JOIN subscriptions s ON p.id = s.user_id
WHERE p.email = 'usuario@exemplo.com';
\`\`\`

### Verificar inconsistÃªncias

\`\`\`sql
-- UsuÃ¡rios com subscription mas etapa errada
SELECT 
  p.email,
  p.etapa_funil,
  s.status,
  CASE
    WHEN s.status = 'trialing' THEN 'Trial'
    WHEN s.status = 'active' THEN 'User'
    ELSE 'Churn'
  END as etapa_esperada
FROM profiles p
JOIN subscriptions s ON p.id = s.user_id
WHERE p.etapa_funil::text != CASE
  WHEN s.status = 'trialing' THEN 'Trial'
  WHEN s.status = 'active' THEN 'User'
  ELSE 'Churn'
END;
\`\`\`

### Corrigir inconsistÃªncias

\`\`\`sql
-- Atualizar etapas baseado nas subscriptions
UPDATE profiles p
SET etapa_funil = CASE
  WHEN s.status = 'trialing' THEN 'Trial'::etapa_funil_type
  WHEN s.status = 'active' THEN 'User'::etapa_funil_type
  WHEN s.status IN ('canceled', 'past_due', 'unpaid') THEN 'Churn'::etapa_funil_type
  ELSE p.etapa_funil
END
FROM subscriptions s
WHERE p.id = s.user_id;
\`\`\`

## Monitoramento

### MÃ©tricas Importantes

1. **Taxa de conversÃ£o Lead â†’ Trial**
\`\`\`sql
SELECT 
  COUNT(CASE WHEN etapa_funil = 'Lead' THEN 1 END) as leads,
  COUNT(CASE WHEN etapa_funil = 'Trial' THEN 1 END) as trials,
  ROUND(
    COUNT(CASE WHEN etapa_funil = 'Trial' THEN 1 END)::numeric / 
    NULLIF(COUNT(CASE WHEN etapa_funil = 'Lead' THEN 1 END), 0) * 100,
    2
  ) as taxa_conversao
FROM profiles;
\`\`\`

2. **Taxa de conversÃ£o Trial â†’ User**
\`\`\`sql
SELECT 
  COUNT(CASE WHEN etapa_funil = 'Trial' THEN 1 END) as trials,
  COUNT(CASE WHEN etapa_funil = 'User' THEN 1 END) as users,
  ROUND(
    COUNT(CASE WHEN etapa_funil = 'User' THEN 1 END)::numeric / 
    NULLIF(COUNT(CASE WHEN etapa_funil = 'Trial' THEN 1 END), 0) * 100,
    2
  ) as taxa_conversao
FROM profiles;
\`\`\`

3. **Taxa de Churn**
\`\`\`sql
SELECT 
  COUNT(CASE WHEN etapa_funil = 'Churn' THEN 1 END) as churned,
  COUNT(*) as total,
  ROUND(
    COUNT(CASE WHEN etapa_funil = 'Churn' THEN 1 END)::numeric / 
    COUNT(*) * 100,
    2
  ) as taxa_churn
FROM profiles;
\`\`\`

## Troubleshooting Comum

### Problema: Subscription criada mas etapa nÃ£o muda

**DiagnÃ³stico:**
\`\`\`sql
-- Verificar se trigger existe
SELECT * FROM information_schema.triggers 
WHERE trigger_name = 'trigger_update_etapa_funil';

-- Ver logs do Postgres
-- (No Supabase Dashboard â†’ Logs â†’ Postgres Logs)
\`\`\`

**SoluÃ§Ã£o:**
\`\`\`sql
-- Recriar trigger
\i scripts/007_fix_etapa_funil_trigger.sql
\`\`\`

### Problema: MÃºltiplas subscriptions para mesmo usuÃ¡rio

**DiagnÃ³stico:**
\`\`\`sql
SELECT user_id, COUNT(*) 
FROM subscriptions 
GROUP BY user_id 
HAVING COUNT(*) > 1;
\`\`\`

**SoluÃ§Ã£o:**
\`\`\`sql
-- Manter apenas a mais recente
DELETE FROM subscriptions
WHERE id NOT IN (
  SELECT DISTINCT ON (user_id) id
  FROM subscriptions
  ORDER BY user_id, created_at DESC
);
\`\`\`

### Problema: Webhook nÃ£o estÃ¡ sendo chamado

**DiagnÃ³stico:**
1. Verificar logs da Vercel
2. Verificar eventos no Stripe Dashboard
3. Testar com "Send test webhook"

**SoluÃ§Ã£o:**
Ver `WEBHOOK_SETUP.md` para configuraÃ§Ã£o completa
